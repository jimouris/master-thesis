\chapter{Implementation Details}\label{c:implementation}

Our application consists of four concrete parts, the \textit{coordinator}, the data providers, the SMPC cluster and the user interface.

\section{Coordinator}\label{s:impl-coordinator}
The \textit{coordinator} handles all private computation requests, communicates with the data providers -- requesting them to securely import their data to the computing cluster, initiates the secure computation in the SMPC cluster, and finally returns to the user the requested analytics results.

The coordinator server has been designed as a Representational State Transfer (REST) web service.
This design helps decoupling server and client applications; the API that provides is cleaner and easier to understand / discover.
It's standard format / usage makes it easy for new clients to use the application even if the application was not designed with these clients' use cases in mind.

We have implemented this web service using \texttt{Node.js} and more specifically the \texttt{Express server} minimal web framework.

The RESTful API provided by the coordinator server can be found in the following section.


\subsection{RESTful API}\label{ss:coord-restful-api}

\begin{table}[H]
  \centering
  \caption{Coordinator's RESTful API}
  \label{t:coordinator-api}
\begin{tabular}{l}
  \includegraphics[page=1,width=\textwidth]{figures/post1.pdf} \\
  \includegraphics[page=1,width=\textwidth]{figures/post2.pdf} \\
  \includegraphics[page=1,width=\textwidth]{figures/post3.pdf} \\
  \includegraphics[page=1,width=\textwidth]{figures/get1.pdf} \\
\end{tabular}
\end{table}


The RESTful API of the \textit{coordinator} is summarized in table \ref{t:coordinator-api}.
Below we explain in more detail each individual POST and GET request.

\includegraphics[page=1,width=\textwidth]{figures/post1.pdf}
\begin{itemize}
  \item[]
  This POST request initiates a secure computation for numerical / continuous values dataset.
  \begin{description}[labelwidth=4em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
       \item[Request:]\ \\
  Through the request's body, one can specify all the desired properties of the histograms to be computed.
  These include the attributes on which the histogram will be built (names and cells -- $\beta$ factor), the datasources from which data will be used, and a set of filters / conditions that should hold for each data tuple taken into consideration when building the histogram.

  %
  % For instance, for the CVI dataset (see section \ref{s:datasets}) a user specifies that he/she wants to compute a histogram with $\beta = 4$ for term ``Patient Age''.

  The request's body is a \texttt{JSON} object with the following properties:

\begin{description}[labelwidth=6em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]

    \item[\texttt{attributes}:] {\color{red}\textit{required}} A list of JSON objects, corresponding to the attributes on which this histogram will be built.
    These JSON objects have the following keys:

    \begin{description}[labelwidth=5em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item[\texttt{name}:] {\color{red}\textit{required}} The name of the attribute (\textit{string}).

        \item[\texttt{cells}:] {\color{red}\textit{required}} The number of histogram cells ($\beta$ factor) to be created for this attribute (\textit{positive integer}).
    \end{description}

    \item[\texttt{datasources}:] {\color{blue}\textit{optional}} A list of the datasources (\textit{strings}) from which the histogram will be computed.
    If this key is left empty or not specified, all available datasources will be used.

    \item[\texttt{filters}:] {\color{blue}\textit{optional}} A JSON object containing a boolean operator and a list of filters / conditions that should be met for each data tuple considered in the secure histogram computation.
    If this field is left blank or not specified, all data tuples will be used for the computation. The object has the following keys:

    \begin{description}[labelwidth=5em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item[\texttt{operator}:] {\color{red}\textit{required}} The boolean operator (\textit{string}) that will be applied between all the specified conditions that follow. One of \texttt{[AND, OR, XOR]}.
        In the case of multiple conditions, the operator is left-associative.

        \item[\texttt{conditions}:] {\color{red}\textit{required}} The list of conditions that should be met by each data tuple in the computation.
        Each condition is represented as a JSON object with the following keys:

        \begin{description}[labelwidth=5em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
            \item[\texttt{attribute}:] {\color{red}\textit{required}} The name of the attribute (\textit{string}).

            \item[\texttt{operator}:] {\color{red}\textit{required}} The condition's operator (\textit{string}). One of \texttt{[>, <, =]}.

            \item[\texttt{value}:] {\color{red}\textit{required}}  The attribute's value (\textit{string}).
        \end{description}

    \end{description}
\end{description}

Example (without \texttt{datasources} or \texttt{filters}):

 \begin{minipage}{\linewidth}
 {
 \begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
   "attributes": [
       {
           "name": "Patient Age",
           "cells": "5"
       },
       {
           "name": "Height (cm)",
           "cells": "3"
       }
   ]
}
 \end{minted}
 \captionof{lstlisting}{Example 1 of /smpc/histogram/numerical POST request body}
 \label{sc:histogram-numerical-post-1}
 }
\end{minipage}

 Example (with \texttt{datasources} and \texttt{filters}):

 \begin{minipage}{\linewidth}
 {
 \begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
   "attributes": [
       {
           "name": "Patient Age",
           "cells": "5"
       },
       {
           "name": "Height (cm)",
           "cells": "3"
       }
   ],
   "datasources": [
       "HospitalA",
       "HospitalB"
   ],
   "filters": {
       "operator": "AND",
       "conditions": [
           {
               "attribute": "Patient Age",
               "operator": ">",
               "value": "45"
           },
           {
               "attribute": "Weight (kg)",
               "operator": "<",
               "value": "90"
           }
       ]
   }
}
 \end{minted}
 \captionof{lstlisting}{Example 2 of /smpc/histogram/numerical POST request body}
 \label{sc:histogram-numerical-post-2}
 }
\end{minipage}

\item[Response:]\ \\


The secure histogram computation is a potentially long running operation. For that reason the server's response to such a request is always \texttt{HTTP/1.1 202 Accepted} in case of correct request, along with a location in which one should periodically poll for the computation's status and/or result. An example response can be found below.
\ \\

\begin{minipage}{\linewidth}
{
\texttt{Status: {\color{ForestGreen}\textbf{202 Accepted}}}
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "location": "/smpc/queue?request=b171-3f4ade123374"
}
\end{minted}
\captionof{lstlisting}{Example 1 of /smpc/histogram/numerical response body}
\label{sc:histogram-numerical-response-1}
}
\end{minipage}

In case of a malformed request the server responds with \texttt{HTTP/1.1 400 Bad Request} as seen below.\\

\begin{minipage}{\linewidth}
{
\texttt{Status: {\color{BrickRed}\textbf{400 Bad Request}}}
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{bash}
Bad Request
\end{minted}
\captionof{lstlisting}{Example 2 of /smpc/histogram/numerical response body}
\label{sc:histogram-numerical-response-2}
}
\end{minipage}

 \end{description}
\end{itemize}




\includegraphics[page=1,width=\textwidth]{figures/post2.pdf}
\begin{itemize}
\item[]
This POST request initiates a secure computation for categorical values dataset (MeSH).
Through the request's body, one can specify the desired MeSH terms.
The values the count of which will be computed are the children of the specified MeSH term from the MeSH ontology.

For example, if a user specifies that he/she wants the counts for the MeSH term ``Age Groups" [M01.060], he/she will get four counts back corresponding to the four children of ``Age Groups", namely ``Adolescent" [M01.060.057], ``Adult" [M01.060.116], ``Child" [M01.060.406] and ``Infant" [M01.060.703].
If the specified MeSH terms are two, then the resulting counts will correspond to tuples of MeSH labels.
If the specified MeSH terms are three, the result will be triples, etc.

\begin{description}[labelwidth=4em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
     \item[Request:]\ \\
The request's body is a \texttt{JSON} object with the following properties:

\begin{description}[labelwidth=6em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]

    \item[\texttt{attributes}:] {\color{red}\textit{required}} A list of MeSH terms, corresponding to the attributes on which this histogram will be built.

    \item[\texttt{datasources}:] {\color{blue}\textit{optional}} A list of the datasources (\textit{strings}) from which the histogram will be computed.
    If this key is left empty or not specified, all available datasources will be used.

    \item[\texttt{filters}:] {\color{blue}\textit{optional}} A JSON object containing a boolean operator and a list of filters / conditions that should be met for each data tuple considered in the secure histogram computation.
    If this field is left blank or not specified, all data tuples will be used for the computation.
    The object has the following keys:

    \begin{description}[labelwidth=6em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item[\texttt{operator}:] {\color{red}\textit{required}} The boolean operator (\textit{string}) that will be applied between all the specified conditions that follow.
        One of \texttt{[AND, OR, XOR]}.
        In the case of multiple conditions, the operator is left-associative.

        \item[\texttt{conditions}:] {\color{red}\textit{required}} The list of conditions that should be met by each data tuple in the computation.
        Note that the only filter that can be applied in categorical values is the equality checking.
        Each condition is represented as a JSON object with the following keys:

        \begin{description}[labelwidth=5em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
            \item[\texttt{attribute}:] {\color{red}\textit{required}} The name of the attribute (\textit{string}).

            \item[\texttt{value}:] {\color{red}\textit{required}} The value that the selected attribute should be equal with (\textit{string}).
        \end{description}

    \end{description}
\end{description}

Example (without \texttt{datasources} or \texttt{filters}):

\begin{minipage}{\linewidth}
{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "attributes": [
        "M01.060",
        "M01.686.508"
    ]
}
\end{minted}
\captionof{lstlisting}{Example 1 of /smpc/histogram/categorical POST request body}
\label{sc:histogram-categorical-post-1}
}
\end{minipage}

Example (with \texttt{datasources} and \texttt{filters}):

\begin{minipage}{\linewidth}
{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "attributes": [
        "M01.060",
        "M01.686.508"
    ],
    "datasources": [
        "HospitalA",
        "HospitalB"
    ],
    "filters": {
        "operator": "OR",
        "conditions": [
            {
                "attribute": "C14",
                "operator": "=",
                "value": "C14.280"
            },
            {
                "attribute": "C12",
                "operator": "=",
                "value": "C12.294"
            }
        ]
    }
}
\end{minted}
\captionof{lstlisting}{Example 2 of /smpc/histogram/categorical POST request body}
\label{sc:histogram-categorical-post-2}
}
\end{minipage}

\item[Response:]\ \\

The server's response for the \texttt{/smpc/histogram/categorical} POST request is identical to that of \texttt{/smpc/histogram/numerical}. The server returns \texttt{HTTP/1.1 202 Accepted} or \texttt{HTTP/1.1 400 Bad Request}. Examples for both cases can be seen in code snippets \ref{sc:histogram-numerical-response-1} and \ref{sc:histogram-numerical-response-2}.
 \end{description}
\end{itemize}




\includegraphics[page=1,width=\textwidth]{figures/post3.pdf}
\begin{itemize}
\item[]
Finally, this POST request is for computing a decision tree from either dataset.
The implemented classifiers are ID3 and C4.5, and one should specify which to use in the request body along with the desired attributes.
Moreover, he/she should specify the class-attribute, according to which the decision tree will occur.

The request's body is a \texttt{JSON} object with the following properties:

\begin{description}[labelwidth=9em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]

    \item[\texttt{attributes}:] {\color{red}\textit{required}} A list of MeSH terms, corresponding to the attributes on which this histogram will be built.
    These JSON objects have the following keys:

    \begin{description}[labelwidth=3em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item[\texttt{name}:] {\color{red}\textit{required}} The name of the attribute (\textit{string}).

        \item[\texttt{cells}:] {\color{red}\textit{required}} The number of histogram cells ($\beta$ factor) to be created for this attribute (\textit{positive integer}). \footnote{A similar JSON is used for both categorical and numerical decision trees. In the former case, this \texttt{cells} object is omitted. \label{refnote}}
    \end{description}

    \item[\texttt{classifier}:] {\color{red}\textit{optional}} The name of the decision tree classifier to be used.
    Possible values are \{\texttt{ID3, C4.5}\}.
    If this key is left empty or not specified, the \texttt{ID3} classifier will be used by default.

    \item[\texttt{class\_attribute}:] {\color{red}\textit{required}} The attribute on which the classification will occur.
    \begin{description}[labelwidth=3em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item[\texttt{name}:] {\color{red}\textit{required}} The name of the class attribute (\textit{string}).

        \item[\texttt{cells}:] {\color{red}\textit{required}} The number of histogram cells ($\beta$ factor) to be created for the class attribute (\textit{positive integer}). \textsuperscript{\ref{refnote}}
    \end{description}

    \item[\texttt{datasources}:] {\color{blue}\textit{optional}} A list of the datasources (\textit{strings}) from which the histogram will be computed.
    If this key is left empty or not specified, all available datasources will be used.

\end{description}

{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "attributes": [
        {
            "name": "Patient Age",
            "cells": "5"
        },
        {
            "name": "Heart rate",
            "cells": "3"
        },
        {
            "name": "Height (cm)",
            "cells": "6"
        }
    ],
    "classifier": "C45",
    "class_attribute": {
        "name": "RVESV (ml)",
        "cells": "3"
    },
    "datasources": [
        "HospitalA",
        "HospitalB"
    ]
}
\end{minted}
\captionof{lstlisting}{Example /smpc/decisionTree POST request body for numerical values}
\label{sc:decisionTree-post-numerical}
}

{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "attributes": [
        "C14",
        "C12"
    ],
    "classifier": "ID3",
    "class_attribute": "M01.060",
    "datasources": [
        "HospitalA",
        "HospitalB"
    ]
}
\end{minted}
\captionof{lstlisting}{Example /smpc/decisionTree POST request body for categorical values}
\label{sc:decisionTree-post-categorical}
}
\end{itemize}


\includegraphics[page=1,width=\textwidth]{figures/get1.pdf}
\begin{itemize}
\item[]
This GET request is for checking the status and/or result of a specified computation request (the aforementioned POST requests).
The status of an ongoing computation request can be accessed through the /smpc/queue GET request by specifying its id.
The only parameter this GET request accepts is the id of the desired computation request, as shown below.

{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "location": "/smpc/queue?request=944222c9-524b-40eb-b19b-486a946c220d"
}
\end{minted}
\captionof{lstlisting}{Example /smpc/queue GET request}
\label{sc:get}
}

The response is a JSON object containing the specified computation's status, and possibly its current step or result which is a JSON object too.
The server's response has the following structure.
\begin{description}[labelwidth=4em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
    \item [\texttt{status}:] A string indicating the computation's status. One of [\texttt{running}, \texttt{succeeded}, \texttt{failed}, \texttt{notstarted}]
    \item [\texttt{step}:] A string indicating the current step of the computation. This is present in case that the computation is in the running state.
    \item [\texttt{result}:] A JSON object with the computation's result in case its status is succeeded. The JSON object contains a single key namely data which contains tuples of (label, value) of the computation result.
    \begin{description}[labelwidth=4em, leftmargin=\dimexpr\labelwidth+\labelsep\relax]
        \item [\texttt{label}:] A string, the value name corresponding to that count. Can be a tuple, triple etc. depending on the number of queried Mesh terms.
        \item [\texttt{value}:] An integer, the actual count for that value.
    \end{description}
\end{description}


{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "status": "succeeded",
    "result": {
        "data": [
            {
                "value": 0,
                "label": "Infant"
            },
            {
                "value": 63,
                "label": "Adolescent"
            },
            {
                "value": 9936,
                "label": "Adult"
            },
            {
                "value": 0,
                "label": "Child"
            }
        ]
    }
}
\end{minted}
\captionof{lstlisting}{Example /smpc/queue GET response body}
\label{sc:get-response}
}

\end{itemize}



\subsection{Sequence of Actions}\label{ss:coordinator-sequence}

\fixme{Explain the procedure in more detail}

\begin{enumerate}
\item A request arises in the coordinator
\item ...
\item main generator
\item compile
\item run
\item ...
\item plot or json
\item ...
\item send back the results
\end{enumerate}


\subsection{Coordinator Logging}\label{ss:coordinator-logging}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Data Providers}\label{s:impl-data-providers}
When a private computation request arises, the \textit{coordinator} communicates with the data providers and requests them to securely import their data to the computing cluster.
Finally the \textit{coordinator} returns the results of the computation to the researcher.

Data providers listen to import requests from the \textit{coordinator} server using a RESTful API, implemented using \texttt{Node.js Express Server}.

\fixme{Specify that a user cannot request data-import, only the coordinator!}


\subsection{RESTful API}\label{ss:data-providers-restful-api}


\begin{table}[H]
  \centering
  \caption{Data Providers' RESTful API}
  \label{t:data-providers-api}
\begin{tabular}{l}
  \includegraphics[page=1,width=\textwidth]{figures/post4.pdf} \\
  \includegraphics[page=1,width=\textwidth]{figures/post5.pdf} \\
\end{tabular}
\end{table}


The RESTful API of the data providers is summarized in table \ref{t:data-providers-api}.
Below we explain in more detail the two types of POST requests that the \textit{coordinator} sends to the data providers.

\includegraphics[page=1,width=\textwidth]{figures/post4.pdf}
\begin{itemize}
\item[]
This POST request initiates a secure import for numerical/continuous values dataset.
Through the request's body, one can specify the desired attribute names of the dataset to import.
For instance, an example for the CVI dataset \ref{s:datasets} is shown in Code \ref{sc:smpc-import-post}, in which a user specifies that he/she wants to compute private analytics for terms ``Patient Age'' and ``Heart rate''.
\end{itemize}

\includegraphics[page=1,width=\textwidth]{figures/post5.pdf}
\begin{itemize}
\item[]
This POST request initiates a secure import for categorical values dataset (MeSH).
Through the request's body, one can specify the desired attribute names of the dataset to import.
The request for importing MeSH dataset is similar to the the numerical one, in Code \ref{sc:smpc-import-post}, however in the attributes should be given MeSH terms.

\end{itemize}

{
\begin{minted}[framesep=3mm, frame=single, tabsize=2, breaklines, breaksymbolleft=, fontsize=\footnotesize]{json}
{
    "attributes": [
        "Patient Age",
        "Heart rate"
    ],
    "datasource": "HospitalA"
}
\end{minted}
\captionof{lstlisting}{Example /smpc/import/numerical POST request body}
\label{sc:smpc-import-post}
}

The post request for categorical/MeSH terms import is similar with Code \ref{sc:smpc-import-post}.
In the attributes list should be given the MeSH identifiers instead of attribute names (i.e. "attributes": [ "C12", "C14", ... ]).
The datasource name is the hospital name along with a unique identifier (uid) (i.e. "datasource": Data-Provider-Name + ``\_" + \{uid\}).
The main reason for this format is that the import procedures are per computation request, not per data-provider.
Thus, there was a need for distinction between the data that are imported for different requests.


\subsection{Data Importer}\label{ss:data-providers-importer}
The secure data import is one of the most essential procedures in the secure multi-party computation scenario.
In this step, the data are secret-shared to the three computing parties.
The shares are part of the secret but reveal nothing about it.
In section \ref{s:secret-sharing}, we examined some secret sharing techniques and the homomorphic properties that some of them have.
In simple words, the secret sharing homomorphic property enables meaningful computation on the shares of the initial data.

Our system is based on Sharemind for the SMPC computation and they also provide a module for the secret sharing import.
However, this module has some restrictions; the data to be imported should be in a comma-separated values (CSV) format.

\fixme{explain what problem does this introduce to MeSH ...}


\subsubsection{Data Preprocessor}\label{sss:data-providers-preprocessor}

\fixme{the solution ...}



\subsection{Docker}\label{ss:data-providers-docker}
The number of data providers can start from two, and is not restricted in how big it can get.
Thus, we wanted the deployment of each server to be easy and fast; veiling all the individual parts, such as the required packages and the SMPC importer installation.
For that reason we have built a Docker image ready for running and accepting requests for data import.
Each individual data provider, can use this image to create a Docker container and then upload his own dataset to the container.

In this way, non-expert users can easily provide their data to be a part of the secure computation.
\fixme{add more here...}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{SMPC Cluster}\label{s:impl-smpc-cluster}

\subsection{SMPC Servers}\label{ss:smpc-cluster-servers}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{User Interface}\label{s:impl-ui}

\fixme{Add screenshots}



\section{Communication}\label{s:impl-communication}

\fixme{Mention https}
\fixme{Mention promises}

